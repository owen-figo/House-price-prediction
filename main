import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor, RandomForestClassifier
from xgboost import XGBRegressor, XGBClassifier
from sklearn.metrics import mean_absolute_error, r2_score, accuracy_score
from sklearn.preprocessing import LabelEncoder
from imblearn.over_sampling import SMOTE

# Load and clean dataset
df = pd.read_csv("190623_rumahcom_tangsel_city_unfiltered.csv", encoding='latin1')

def clean_price(price_str):
    if isinstance(price_str, str):
        price_str = price_str.replace(" ", "").replace(",", "").replace("M", "e6").replace("Jt", "e6")
        try: return float(price_str)
        except ValueError: return np.nan
    return price_str

def clean_area(area_str):
    if isinstance(area_str, str):
        area_str = area_str.replace(" m²", "").replace(",", "")
        try: return float(area_str)
        except ValueError: return np.nan
    return area_str

def clean_price_per_m2(price_m2_str):
    if isinstance(price_m2_str, str):
        price_m2_str = price_m2_str.replace("Rp\xa0", "").replace(".", "").replace("\xa0per\xa0m²", "").replace(",", "")
        try: return float(price_m2_str)
        except ValueError: return np.nan
    return price_m2_str

df['price_numeric'] = df['price'].apply(clean_price)
df['listing-floorarea_numeric'] = df['listing-floorarea'].apply(clean_area)
df['listing-floorarea_2_numeric'] = df['listing-floorarea 2'].apply(clean_price_per_m2)

relevant_cols = ["bed", "bath", "listing-floorarea_numeric", "listing-floorarea_2_numeric", "listing-location", "price_numeric"]
df.dropna(subset=relevant_cols, inplace=True)

le_location = LabelEncoder()
df["location_enc"] = le_location.fit_transform(df["listing-location"])

y_reg = df["price_numeric"]
bins = pd.qcut(df["price_numeric"], q=3, labels=["Murah", "Sedang", "Mahal"])
y_class = bins

le_class = LabelEncoder()
y_class_encoded = le_class.fit_transform(y_class)

features = [
    "bed",
    "bath",
    "listing-floorarea_numeric",
    "listing-floorarea_2_numeric",
    "location_enc",
]
X = df[features]

X_train_reg, X_test_reg, y_train_reg, y_test_reg = train_test_split(X, y_reg, test_size=0.2, random_state=42)
X_train_cls, X_test_cls, y_train_cls_encoded, y_test_cls_encoded = train_test_split(X, y_class_encoded, test_size=0.2, random_state=42)

smote = SMOTE(random_state=42)
X_train_cls_smote, y_train_cls_smote_encoded = smote.fit_resample(X_train_cls, y_train_cls_encoded)

rf_reg = RandomForestRegressor(random_state=42)
rf_reg.fit(X_train_reg, y_train_reg)

xgb_reg = XGBRegressor(random_state=42, verbosity=0)
xgb_reg.fit(X_train_reg, y_train_reg)

rf_cls = RandomForestClassifier(random_state=42)
rf_cls.fit(X_train_cls_smote, le_class.inverse_transform(y_train_cls_smote_encoded))

xgb_cls = XGBClassifier(random_state=42, verbosity=0)
xgb_cls.fit(X_train_cls_smote, y_train_cls_smote_encoded)

# === INPUT PROMPT ===
print("\n=== Prediksi Harga Rumah ===")
mode = input("Pilih mode (regresi/klasifikasi): ").lower()
bed = int(input("Jumlah kamar tidur: "))
bath = int(input("Jumlah kamar mandi: "))
tanah = float(input("Luas tanah (m2): "))
bangunan = float(input("Luas bangunan (m2): "))

# Show available locations
print("\nLokasi yang tersedia:")
for i, loc in enumerate(le_location.classes_):
    print(f"{i}. {loc}")
loc_idx = int(input("Pilih lokasi (nomor): "))
location = le_location.transform([le_location.classes_[loc_idx]])[0]

model = input("Pilih model (rf/xgb): ").lower()

input_data = np.array([[bed, bath, tanah, bangunan, location]])

if mode == "regresi":
    if model == "rf":
        pred = rf_reg.predict(input_data)[0]
    else:
        pred = xgb_reg.predict(input_data)[0]
    print(f"\nPerkiraan harga: Rp {int(pred):,}")
elif mode == "klasifikasi":
    if model == "rf":
        pred_class = rf_cls.predict(input_data)[0]
    else:
        pred_class_encoded = xgb_cls.predict(input_data)[0]
        pred_class = le_class.inverse_transform([pred_class_encoded])[0]
    print(f"\nKategori harga: {pred_class}")
else:
    print("Mode tidak dikenali.")
